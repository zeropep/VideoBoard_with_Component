<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.videoboard.boot.repository.VideoDAO">
    <insert id="insertVideo" parameterType="VideoVO" useGeneratedKeys="true" keyProperty="vno" keyColumn="vno">
		insert into video (title, username, mno, description) values (#{title}, #{username}, #{mno}, #{description})
	</insert>
	
	<sql id="search">
		<if test="keyword != null">
				and (title like concat('%',#{keyword},'%') or username like concat('%',#{keyword},'%'))
		</if>
	</sql>
	
	<select id="selectAllVideos" parameterType="PagingVO" resultType="VideoVO">
		select a.vno, f.fno, b.mno, b.title, b.description, b.username, b.like_count, b.cmt_count, b.view_count, 
		b.created_at, b.modified_at, f.uuid, f.save_dir, f.file_name, f.file_ext, f.file_type, f.poster
		from (
			select vno from video
			where vno > 0 
			<include refid="search"></include>
			order by vno desc
			limit #{pageStart}, #{qty}
		) a 
		left join video b on a.vno = b.vno
		left join file f on a.vno = f.vno
		where f.is_delete = 'n'
		order by vno desc
	</select>
	
	<select id="selectVideosByUsername" resultType="VideoVO">
		select a.vno, f.fno, b.mno, b.title, b.description, b.username, b.like_count, b.cmt_count, b.view_count, 
		b.created_at, b.modified_at, f.uuid, f.save_dir, f.file_name, f.file_ext, f.file_type, f.poster
		from (
			select vno from video
			where vno > 0 
			and username = #{username}
			order by vno desc
			limit #{pgvo.pageStart}, #{pgvo.qty}
		) a 
		left join video b on a.vno = b.vno
		inner join file f on a.vno = f.vno
		where f.is_delete = 'n'
		order by vno desc
	</select>
	
	<select id="videoDetail" parameterType="long" resultType="VideoVO">
		select * from video where vno = ${vno}
	</select>
	
	<update id="updateVideo" parameterType="VideoVO">
		update video set title = #{title}, description = #{description}, modified_at = now() where vno = #{vno}
	</update>
	
	<update id="addCmtCount" parameterType="long">
		update video set cmt_count = cmt_count + 1 where vno = #{vno}
	</update>

	<update id="downCmtCount" parameterType="long">
		update video set cmt_count = cmt_count - 1 where vno = #{vno}
	</update>
	
	<update id="addLikeCount" parameterType="long">
		update video set like_count = like_count + 1 where vno = #{vno}
	</update>

	<update id="downLikeCount" parameterType="long">
		update video set like_count = like_count - 1 where vno = #{vno}
	</update>
	
	<update id="addViewCount" parameterType="long">
		update video set view_count = view_count + 1 where vno = #{vno}
	</update>
	
	<delete id="deleteVideo" parameterType="long"> 
		delete from video where vno = #{vno}
	</delete>
	
	<sql id="searchCount">
		<if test="keyword != null">
				and (title like concat('%',#{keyword},'%') or username like concat('%',#{keyword},'%'))
		</if>
	</sql>
	
	<select id="selectTotalCount" parameterType="String" resultType="int">
		select count(vno) from video where vno > 0
		<include refid="searchCount"></include>
	</select>
	
	<select id="selectCountByUsername" parameterType="String" resultType="int">
		select count(vno) from video where vno > 0 and username = #{username}
	</select>
</mapper>